name: Bisect Rustc from URL Content

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL containing the code to bisect (raw Rust file)'
        required: true
        type: string

jobs:
  bisect:
    runs-on: ubuntu-latest
    steps:
      - name: Install rustup and stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          
      - name: Create test project from URL
        run: |
          mkdir test-project
          cd test-project
          mkdir src
          echo 'fn main() {' > src/main.rs
          curl -L "${{ github.event.inputs.url }}" >> src/main.rs
          echo '}' >> src/main.rs
          cat > Cargo.toml << 'EOF'
          [package]
          name = "test-project"
          version = "0.1.0"
          edition = "2021"

          [dependencies]
          EOF
          cat Cargo.toml
          cat src/main.rs
          cargo run || true
          echo "test-project-dir=$(pwd)" >> $GITHUB_ENV

      - name: Install cargo-bisect-rustc with locked deps
        run: cargo install cargo-bisect-rustc --locked

      - name: Run cargo-bisect-rustc
        run: |
          cd ${{ env.test-project-dir }}
          pwd
          cargo bisect-rustc --regress="error" \
            --access=github \
            --start=1.80.0 -vv -- run
        working-directory: ${{ env.test-project-dir }}

